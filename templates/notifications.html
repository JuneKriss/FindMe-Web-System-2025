{% load static %}

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="{% static 'css/notification.css' %}" />
    <link rel="stylesheet" href="{% static 'css/fonts.css' %}" />

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <title>Notifications</title>
  </head>
  <body>
    <div class="container">
      {% include 'components/sidebar.html' %}
      <div class="main">
        <div class="title">
          <h2 class="poppins-medium">Notifications</h2>
        </div>
        <div class="bottomContainer">
          <p class="poppins-regular">
            You have <span class="notif_count">4</span> notifications to go through
          </p>
          <button class="button" id="filterBtn">
            <i data-lucide="check"></i>
            <span class="poppins-regular">Mark all as read</span>
          </button>
        </div>
        <section>
          {# ---------------------- TODAY ---------------------- #}
          {% if grouped_notifications.today %}
            <div class="notification-group">
              <h2 class="poppins-medium">Today</h2>
              <div class="notification-container">
                {% for n in grouped_notifications.today %}
                  {% with notif=n.notif user_notif=n.user_notif %}
                    <div class="notification {% if user_notif.is_read %}read{% endif %}">
                      <div class="left">
                        <div class="icon">
                          {% if notif.action == "new_message" %}
                            <i data-lucide="message-circle"></i>
                          {% elif notif.action == "report_created" %}
                            <i data-lucide="file-plus"></i>
                          {% elif notif.action == "report_updated" %}
                            <i data-lucide="file-edit"></i>
                          {% elif notif.action == "status_changed" %}
                            <i data-lucide="refresh-ccw"></i>
                          {% else %}
                            <i data-lucide="bell"></i>
                          {% endif %}
                        </div>
                        <div class="texts">
                          <div class="top">
                            <h3 class="poppins-medium">{{ notif.title }}</h3>
                            <span class="poppins-regular">{{ n.display_time }}</span>
                          </div>
                          <div class="bottom">
                            <p class="poppins-regular">
                              {% if notif.related_report %}
                                Missing Person: {{ notif.related_report.full_name }}
                              {% else %}
                                No related report
                              {% endif %}
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="right">
                        {% if not user_notif.is_read %}
                          <i
                            data-lucide="check"
                            class="mark-read"
                            data-id="{{ user_notif.id }}"
                          ></i>
                        {% endif %}
                        <i
                          data-lucide="trash"
                          class="delete-notif"
                          data-id="{{ user_notif.id }}"
                        ></i>
                      </div>
                    </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {# ---------------------- YESTERDAY ---------------------- #}
          {% if grouped_notifications.yesterday %}
            <div class="notification-group">
              <h2 class="poppins-medium">Yesterday</h2>
              <div class="notification-container">
                {% for n in grouped_notifications.yesterday %}
                  {% with notif=n.notif user_notif=n.user_notif %}
                    <div class="notification {% if user_notif.is_read %}read{% endif %}">
                      <div class="left">
                        <div class="icon">
                          {% if notif.action == "new_message" %}
                            <i data-lucide="message-circle"></i>
                          {% elif notif.action == "report_created" %}
                            <i data-lucide="file-plus"></i>
                          {% elif notif.action == "report_updated" %}
                            <i data-lucide="file-edit"></i>
                          {% elif notif.action == "status_changed" %}
                            <i data-lucide="refresh-ccw"></i>
                          {% else %}
                            <i data-lucide="bell"></i>
                          {% endif %}
                        </div>
                        <div class="texts">
                          <div class="top">
                            <h3 class="poppins-medium">{{ notif.title }}</h3>
                            <span class="poppins-regular">{{ n.display_time }}</span>
                          </div>
                          <div class="bottom">
                            <p class="poppins-regular">
                              {% if notif.related_report %}
                                Missing Person: {{ notif.related_report.full_name }}
                              {% else %}
                                No related report
                              {% endif %}
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="right">
                        {% if not user_notif.is_read %}
                          <i
                            data-lucide="check"
                            class="mark-read"
                            data-id="{{ user_notif.id }}"
                          ></i>
                        {% endif %}
                        <i
                          data-lucide="trash"
                          class="delete-notif"
                          data-id="{{ user_notif.id }}"
                        ></i>
                      </div>
                    </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {# ---------------------- EARLIER ---------------------- #}
          {% if grouped_notifications.earlier %}
            <div class="notification-group">
              <h2 class="poppins-medium">Earlier</h2>
              <div class="notification-container">
                {% for n in grouped_notifications.earlier %}
                  {% with notif=n.notif user_notif=n.user_notif %}
                    <div class="notification {% if user_notif.is_read %}read{% endif %}">
                      <div class="left">
                        <div class="icon">
                          {% if notif.action == "new_message" %}
                            <i data-lucide="message-circle"></i>
                          {% elif notif.action == "report_created" %}
                            <i data-lucide="file-plus"></i>
                          {% elif notif.action == "report_updated" %}
                            <i data-lucide="file-edit"></i>
                          {% elif notif.action == "status_changed" %}
                            <i data-lucide="refresh-ccw"></i>
                          {% else %}
                            <i data-lucide="bell"></i>
                          {% endif %}
                        </div>
                        <div class="texts">
                          <div class="top">
                            <h3 class="poppins-medium">{{ notif.title }}</h3>
                            <span class="poppins-regular">{{ n.display_time }}</span>
                          </div>
                          <div class="bottom">
                            <p class="poppins-regular">
                              {% if notif.related_report %}
                                Missing Person: {{ notif.related_report.full_name }}
                              {% else %}
                                No related report
                              {% endif %}
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="right">
                        {% if not user_notif.is_read %}
                          <i
                            data-lucide="check"
                            class="mark-read"
                            data-id="{{ user_notif.id }}"
                          ></i>
                        {% endif %}
                        <i
                          data-lucide="trash"
                          class="delete-notif"
                          data-id="{{ user_notif.id }}"
                        ></i>
                      </div>
                    </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </section>
      </div>
    </div>

    <script>
      lucide.createIcons();

      // Mark as read
      const checkIcons = document.querySelectorAll(".mark-read");

      checkIcons.forEach((icon) => {
        icon.addEventListener("click", () => {
          const notifId = icon.getAttribute("data-id");

          fetch(`/notifications/mark-read/${notifId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const notifDiv = icon.closest(".notification");
                notifDiv.classList.add("read");

                icon.classList.add("fade-out");
                setTimeout(() => icon.remove(), 200);
              }
            })
            .catch((err) => console.error("Error:", err));
        });
      });

      // Delete notification
      const deleteIcons = document.querySelectorAll(".delete-notif");
      deleteIcons.forEach((icon) => {
        icon.addEventListener("click", () => {
          const notifId = icon.getAttribute("data-id");

          fetch(`/notifications/delete/${notifId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const notifDiv = icon.closest(".notification");
                notifDiv.classList.add("fade-out");
                setTimeout(() => notifDiv.remove(), 200);
              }
            });
        });
      });

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      const markAllBtn = document.getElementById("filterBtn");

      if (markAllBtn) {
        markAllBtn.addEventListener("click", () => {
          Swal.fire({
            title: "Mark all as read?",
            text: "This will mark all unread notifications as read.",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Yes, mark all",
            cancelButtonText: "Cancel",
            customClass: {
              title: "poppins-regular swal-title",
              htmlContainer: "poppins-regular swal-text",
              confirmButton: "poppins-medium swal-confirm",
              cancelButton: "poppins-medium swal-cancel",
            },
          }).then((result) => {
            if (result.isConfirmed) {
              fetch("/notifications/mark-all-read/", {
                method: "POST",
                headers: {
                  "X-CSRFToken": getCookie("csrftoken"),
                },
              })
                .then((res) => res.json())
                .then((data) => {
                  if (data.success) {
                    Swal.fire({
                      position: "top-end",
                      icon: "success",
                      title: data.message || "All notifications marked as read.",
                      showConfirmButton: false,
                      timer: 1500,
                      customClass: {
                        popup: "my-swal-popup",
                        title: "poppins-medium my-swal-title",
                        icon: "my-swal-icon",
                      },
                    }).then(() => {
                      document.querySelectorAll(".notification").forEach((notif) => {
                        notif.classList.add("read");
                        const checkIcon = notif.querySelector(".mark-read");
                        if (checkIcon) checkIcon.remove();
                      });
                    });
                  } else {
                    Swal.fire({
                      title: "No unread notifications",
                      text: data.message || "You’re already up to date!",
                      icon: "info",
                      confirmButtonText: "OK",
                      customClass: {
                        title: "poppins-regular swal-title",
                        htmlContainer: "poppins-regular swal-text",
                        confirmButton: "poppins-medium swal-confirm",
                      },
                    });
                  }
                })
                .catch((err) => {
                  Swal.fire({
                    title: "Error",
                    text: "Something went wrong. Please try again later.",
                    icon: "error",
                    confirmButtonText: "OK",
                    customClass: {
                      title: "poppins-regular swal-title",
                      htmlContainer: "poppins-regular swal-text",
                      confirmButton: "poppins-medium swal-confirm",
                    },
                  });
                  console.error(err);
                });
            }
          });
        });
      }
    </script>

    {% if debug %}
      <script src="{% static 'django_browser_reload/reload.js' %}"></script>
    {% endif %}
  </body>
</html>
